<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Vim Space Exploration Game</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: black;
        }
        #editor-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background: #1e1e1e;
            border: 2px solid white;
            z-index: 10;
        }
        .CodeMirror {
            height: 100%;
            font-size: 16px;
        }
        #command-input {
            position: absolute;
            bottom: 40px;
            left: 10px;
            color: white;
            font-family: monospace;
            z-index: 10;
        }
        #score {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-family: monospace;
            z-index: 10;
        }
        #mode-indicator {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-family: monospace;
            z-index: 10;
        }
        #level-message {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-family: monospace;
            display: none;
            z-index: 10;
        }
        #playlist-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 60%;
            background: #1e1e1e;
            border: 2px solid white;
            color: white;
            font-family: monospace;
            padding: 20px;
            display: none;
            overflow: auto;
            z-index: 10;
        }
        #about-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            max-width: 560px;
            background: #1e1e1e;
            border: 2px solid white;
            color: white;
            font-family: monospace;
            padding: 20px;
            display: none;
            line-height: 1.5;
            word-break: break-word;
            z-index: 10;
        }
        #about-container a {
            color: #00b7eb;
            text-decoration: none;
        }
        #about-container a:hover {
            text-decoration: underline;
        }
        .mode-button {
            position: absolute;
            bottom: 10px;
            color: white;
            background: #333;
            border: 1px solid white;
            padding: 5px 10px;
            font-family: monospace;
            cursor: pointer;
            z-index: 10;
        }
        #flight-button { left: 20%; }
        #insert-button { left: 40%; }
        #playlist-button { left: 60%; }
        #about-button { right: 10px; }
        canvas {
            z-index: 0;
            position: fixed;
            top: 0;
            left: 0;
        }
    </style>
    <link rel="stylesheet" href="js/vendor/codemirror.css">
    <script src="js/playlist.js"></script>
    <script src="js/vendor/three.min.js"></script>
    <script src="js/vendor/OrbitControls.js"></script>
    <script src="js/vendor/codemirror.min.js"></script>
    <script src="js/vendor/vim.min.js"></script>
</head>
<body>
    <div id="editor-container" style="display: none;"></div>
    <div id="command-input">Command: </div>
    <div id="score">Score: 0</div>
    <div id="mode-indicator">Flight Mode</div>
    <div id="level-message">Type i to initiate planetary landing sequence</div>
    <div id="playlist-container"></div>
    <div id="about-container">
        <h3>About</h3>
        <p>This page is open source. Edit it here:</p>
        <p>
          <a href="https://github.com/standardgalactic/userland/blob/main/index.html" target="_blank" rel="noopener">
            https://github.com/standardgalactic/userland/blob/main/index.html
          </a>
        </p>
        <p>Press <strong>Esc</strong> to close.</p>
    </div>
    <button id="flight-button" class="mode-button">Flight Mode (f)</button>
    <button id="insert-button" class="mode-button">Insert Mode (i/space)</button>
    <button id="playlist-button" class="mode-button">Playlist Mode (p)</button>
    <button id="about-button" class="mode-button">About (/ or ?)</button>
    <script>
        // Global variables
        let scene, camera, renderer, controls;
        let levels = [], stars, dustParticles;
        let flightMode = true;
        let pressedKeys = new Set();
        let movementSpeed = 5;
        let rotationSpeed = Math.PI / 180 * 2;
        let currentLevel = 0;
        let commandBuffer = '';
        let score = 0;
        let isBubbleMode = false;
        let bubbles = [];
        let editor;
        let skillLevel = 'beginner';
        let startTime = 0;
        let selectedLevel = null;
        let halo = null;
        let triangles = [];
        let playlistMode = false;
        let playlistIndex = 0;
        let aboutMode = false;
        let tracks = [];

        // Diagnostics
        console.log("[diag] THREE:", typeof THREE, 
                    "| OrbitControls:", typeof window.OrbitControls, 
                    "| playlistFiles:", Array.isArray(window.playlistFiles) ? window.playlistFiles : "missing");

        // Sounds
        const popSound = new Audio('assets/sounds/pop.wav');
        const levelCompleteSound = new Audio('assets/sounds/level_complete.wav');
        const errorSound = new Audio('assets/sounds/error.wav');
        popSound.volume = 0.3;
        levelCompleteSound.volume = 0.3;
        errorSound.volume = 0.3;

        // Playlist
        let backgroundSound;
        try {
            let attempts = 0;
            const maxAttempts = 3;
            function loadPlaylistFiles() {
                if (Array.isArray(window.playlistFiles) && window.playlistFiles.length) {
                    tracks = window.playlistFiles.slice();
                    console.log("[diag] playlistFiles loaded:", tracks);
                } else {
                    console.warn('playlistFiles is empty or missing');
                    tracks = [];
                    if (attempts < maxAttempts) {
                        attempts++;
                        console.log(`[diag] Retrying playlistFiles load (${attempts}/${maxAttempts})...`);
                        setTimeout(loadPlaylistFiles, 100);
                    } else {
                        console.error("Failed to load playlistFiles after retries");
                    }
                }
            }
            loadPlaylistFiles();
            if (tracks.length > 0) {
                let validTrack = tracks[0];
                try {
                    const testAudio = new Audio(validTrack);
                    testAudio.load();
                } catch (e) {
                    console.warn(`Failed to load ${validTrack}, trying js/playlist/...`);
                    validTrack = `js/${validTrack}`;
                }
                backgroundSound = new Audio(validTrack);
                backgroundSound.loop = false;
                backgroundSound.volume = 0.3;
                backgroundSound.addEventListener('ended', () => {
                    playlistIndex = (playlistIndex + 1) % tracks.length;
                    const track = tracks[playlistIndex].startsWith('playlist/') ? tracks[playlistIndex] : `js/${tracks[playlistIndex]}`;
                    backgroundSound.src = track;
                    backgroundSound.play().catch(() => console.log("Audio play blocked"));
                    updatePlaylistViewer();
                });
                backgroundSound.load();
            } else {
                backgroundSound = null;
            }
        } catch (e) {
            console.error("Playlist initialization error:", e);
        }

        // Audio unlock
        function unlockAudioOnce() {
            if (backgroundSound) {
                backgroundSound.play().catch(() => console.log("Audio play blocked"));
            }
            document.removeEventListener('keydown', unlockAudioOnce);
            document.removeEventListener('click', unlockAudioOnce);
        }
        document.addEventListener('keydown', unlockAudioOnce);
        document.addEventListener('click', unlockAudioOnce);

        // Commands data
        const commands = [
            {"level": 0, "command": "h", "description": "Move left", "difficulty": "beginner"},
            {"level": 0, "command": "j", "description": "Move down", "difficulty": "beginner"},
            {"level": 1, "command": "dd", "description": "Delete line", "difficulty": "intermediate"},
            {"level": 2, "command": ":s", "description": "Substitute", "difficulty": "advanced"},
            {"level": 3, "command": "yy", "description": "Yank line", "difficulty": "intermediate"},
            {"level": 4, "command": "p", "description": "Paste", "difficulty": "intermediate"},
            {"level": 5, "command": "/", "description": "Search", "difficulty": "advanced"},
            {"level": 6, "command": "q", "description": "Record macro", "difficulty": "advanced"},
            {"level": 7, "command": "Ctrl-v", "description": "Visual block", "difficulty": "advanced"},
            {"level": 8, "command": "i", "description": "Insert", "difficulty": "beginner"},
            {"level": 9, "command": ":w", "description": "Save", "difficulty": "beginner"},
            {"level": 10, "command": "k", "description": "Move up", "difficulty": "beginner"},
            {"level": 11, "command": "l", "description": "Move right", "difficulty": "beginner"},
            {"level": 12, "command": "gg", "description": "Go to top", "difficulty": "intermediate"},
            {"level": 13, "command": "G", "description": "Go to bottom", "difficulty": "intermediate"},
            {"level": 14, "command": "u", "description": "Undo", "difficulty": "beginner"},
            {"level": 15, "command": "Ctrl-r", "description": "Redo", "difficulty": "intermediate"},
            {"level": 16, "command": "o", "description": "Open line below", "difficulty": "beginner"},
            {"level": 17, "command": "O", "description": "Open line above", "difficulty": "beginner"},
            {"level": 18, "command": "a", "description": "Append after cursor", "difficulty": "beginner"},
            {"level": 19, "command": "A", "description": "Append at end of line", "difficulty": "beginner"},
            {"level": 20, "command": "x", "description": "Delete character", "difficulty": "beginner"},
            {"level": 21, "command": "r", "description": "Replace character", "difficulty": "intermediate"},
            {"level": 22, "command": ":", "description": "Command mode", "difficulty": "beginner"},
            {"level": 23, "command": "w", "description": "Move word forward", "difficulty": "beginner"},
            {"level": 24, "command": "b", "description": "Move word backward", "difficulty": "beginner"},
            {"level": 25, "command": "e", "description": "Move to end of word", "difficulty": "beginner"},
            {"level": 26, "command": "0", "description": "Move to start of line", "difficulty": "beginner"},
            {"level": 27, "command": "$", "description": "Move to end of line", "difficulty": "beginner"},
            {"level": 28, "command": "%", "description": "Move to matching bracket", "difficulty": "intermediate"},
            {"level": 29, "command": "f", "description": "Find character forward", "difficulty": "intermediate"},
            {"level": 30, "command": "F", "description": "Find character backward", "difficulty": "intermediate"},
            {"level": 31, "command": "t", "description": "Till character forward", "difficulty": "intermediate"},
            {"level": 32, "command": "T", "description": "Till character backward", "difficulty": "intermediate"},
            {"level": 33, "command": ";", "description": "Repeat last find", "difficulty": "intermediate"},
            {"level": 34, "command": ",", "description": "Repeat last find reverse", "difficulty": "intermediate"},
            {"level": 35, "command": "ciw", "description": "Change in word", "difficulty": "advanced"},
            {"level": 36, "command": "diw", "description": "Delete in word", "difficulty": "advanced"},
            {"level": 37, "command": "yiw", "description": "Yank in word", "difficulty": "advanced"},
            {"level": 38, "command": "viw", "description": "Visual in word", "difficulty": "advanced"},
            {"level": 39, "command": "dw", "description": "Delete word", "difficulty": "intermediate"},
            {"level": 40, "command": "cw", "description": "Change word", "difficulty": "intermediate"},
            {"level": 41, "command": "yw", "description": "Yank word", "difficulty": "intermediate"},
            {"level": 42, "command": "vw", "description": "Visual word", "difficulty": "intermediate"},
            {"level": 43, "command": "d$", "description": "Delete to end of line", "difficulty": "intermediate"},
            {"level": 44, "command": "c$", "description": "Change to end of line", "difficulty": "intermediate"},
            {"level": 45, "command": "y$", "description": "Yank to end of line", "difficulty": "intermediate"},
            {"level": 46, "command": "v$", "description": "Visual to end of line", "difficulty": "intermediate"},
            {"level": 47, "command": "d0", "description": "Delete to start of line", "difficulty": "intermediate"},
            {"level": 48, "command": "c0", "description": "Change to start of line", "difficulty": "intermediate"},
            {"level": 49, "command": "y0", "description": "Yank to start of line", "difficulty": "intermediate"},
            {"level": 50, "command": "v0", "description": "Visual to start of line", "difficulty": "intermediate"},
            {"level": 51, "command": "gg", "description": "Go to top of file", "difficulty": "intermediate"},
            {"level": 52, "command": "G", "description": "Go to bottom of file", "difficulty": "intermediate"},
            {"level": 53, "command": "u", "description": "Undo", "difficulty": "beginner"},
            {"level": 54, "command": "Ctrl-r", "description": "Redo", "difficulty": "intermediate"},
            {"level": 55, "command": "o", "description": "Open line below", "difficulty": "beginner"},
            {"level": 56, "command": "O", "description": "Open line above", "difficulty": "beginner"},
            {"level": 57, "command": "a", "description": "Append after cursor", "difficulty": "beginner"},
            {"level": 58, "command": "A", "description": "Append at end of line", "difficulty": "beginner"},
            {"level": 59, "command": "x", "description": "Delete character", "difficulty": "beginner"},
            {"level": 60, "command": "r", "description": "Replace character", "difficulty": "intermediate"},
            {"level": 61, "command": ":", "description": "Command mode", "difficulty": "beginner"},
            {"level": 62, "command": "w", "description": "Move word forward", "difficulty": "beginner"},
            {"level": 63, "command": "b", "description": "Move word backward", "difficulty": "beginner"},
            {"level": 64, "command": "e", "description": "Move to end of word", "difficulty": "beginner"},
            {"level": 65, "command": "0", "description": "Move to start of line", "difficulty": "beginner"},
            {"level": 66, "command": "$", "description": "Move to end of line", "difficulty": "beginner"},
            {"level": 67, "command": "%", "description": "Move to matching bracket", "difficulty": "intermediate"},
            {"level": 68, "command": "f", "description": "Find character forward", "difficulty": "intermediate"},
            {"level": 69, "command": "F", "description": "Find character backward", "difficulty": "intermediate"},
            {"level": 70, "command": "t", "description": "Till character forward", "difficulty": "intermediate"},
            {"level": 71, "command": "T", "description": "Till character backward", "difficulty": "intermediate"},
            {"level": 72, "command": ";", "description": "Repeat last find", "difficulty": "intermediate"},
            {"level": 73, "command": ",", "description": "Repeat last find reverse", "difficulty": "intermediate"},
            {"level": 74, "command": "ciw", "description": "Change in word", "difficulty": "advanced"},
            {"level": 75, "command": "diw", "description": "Delete in word", "difficulty": "advanced"},
            {"level": 76, "command": "yiw", "description": "Yank in word", "difficulty": "advanced"},
            {"level": 77, "command": "viw", "description": "Visual in word", "difficulty": "advanced"},
            {"level": 78, "command": "dw", "description": "Delete word", "difficulty": "intermediate"},
            {"level": 79, "command": "cw", "description": "Change word", "difficulty": "intermediate"},
            {"level": 80, "command": "yw", "description": "Yank word", "difficulty": "intermediate"},
            {"level": 81, "command": "vw", "description": "Visual word", "difficulty": "intermediate"},
            {"level": 82, "command": "d$", "description": "Delete to end of line", "difficulty": "intermediate"},
            {"level": 83, "command": "c$", "description": "Change to end of line", "difficulty": "intermediate"},
            {"level": 84, "command": "y$", "description": "Yank to end of line", "difficulty": "intermediate"},
            {"level": 85, "command": "v$", "description": "Visual to end of line", "difficulty": "intermediate"},
            {"level": 86, "command": "d0", "description": "Delete to start of line", "difficulty": "intermediate"},
            {"level": 87, "command": "c0", "description": "Change to start of line", "difficulty": "intermediate"},
            {"level": 88, "command": "y0", "description": "Yank to start of line", "difficulty": "intermediate"},
            {"level": 89, "command": "v0", "description": "Visual to start of line", "difficulty": "intermediate"},
            {"level": 90, "command": "gg", "description": "Go to top of file", "difficulty": "intermediate"},
            {"level": 91, "command": "G", "description": "Go to bottom of file", "difficulty": "intermediate"},
            {"level": 92, "command": "u", "description": "Undo", "difficulty": "beginner"},
            {"level": 93, "command": "Ctrl-r", "description": "Redo", "difficulty": "intermediate"},
            {"level": 94, "command": "o", "description": "Open line below", "difficulty": "beginner"},
            {"level": 95, "command": "O", "description": "Open line above", "difficulty": "beginner"},
            {"level": 96, "command": "a", "description": "Append after cursor", "difficulty": "beginner"},
            {"level": 97, "command": "A", "description": "Append at end of line", "difficulty": "beginner"},
            {"level": 98, "command": "x", "description": "Delete character", "difficulty": "beginner"},
            {"level": 99, "command": "r", "description": "Replace character", "difficulty": "intermediate"},
            {"level": 100, "command": ":", "description": "Command mode", "difficulty": "beginner"},
            {"level": 101, "command": "w", "description": "Move word forward", "difficulty": "beginner"},
            {"level": 102, "command": "b", "description": "Move word backward", "difficulty": "beginner"},
            {"level": 103, "command": "e", "description": "Move to end of word", "difficulty": "beginner"},
            {"level": 104, "command": "0", "description": "Move to start of line", "difficulty": "beginner"},
            {"level": 105, "command": "$", "description": "Move to end of line", "difficulty": "beginner"},
            {"level": 106, "command": "%", "description": "Move to matching bracket", "difficulty": "intermediate"},
            {"level": 107, "command": "f", "description": "Find character forward", "difficulty": "intermediate"},
            {"level": 108, "command": "F", "description": "Find character backward", "difficulty": "intermediate"},
            {"level": 109, "command": "t", "description": "Till character forward", "difficulty": "intermediate"},
            {"level": 110, "command": "T", "description": "Till character backward", "difficulty": "intermediate"},
            {"level": 111, "command": ";", "description": "Repeat last find", "difficulty": "intermediate"},
            {"level": 112, "command": ",", "description": "Repeat last find reverse", "difficulty": "intermediate"},
            {"level": 113, "command": "ciw", "description": "Change in word", "difficulty": "advanced"},
            {"level": 114, "command": "diw", "description": "Delete in word", "difficulty": "advanced"},
            {"level": 115, "command": "yiw", "description": "Yank in word", "difficulty": "advanced"},
            {"level": 116, "command": "viw", "description": "Visual in word", "difficulty": "advanced"},
            {"level": 117, "command": "dw", "description": "Delete word", "difficulty": "intermediate"},
            {"level": 118, "command": "cw", "description": "Change word", "difficulty": "intermediate"},
            {"level": 119, "command": "yw", "description": "Yank word", "difficulty": "intermediate"},
            {"level": 120, "command": "vw", "description": "Visual word", "difficulty": "intermediate"},
            {"level": 121, "command": "d$", "description": "Delete to end of line", "difficulty": "intermediate"},
            {"level": 122, "command": "c$", "description": "Change to end of line", "difficulty": "intermediate"},
            {"level": 123, "command": "y$", "description": "Yank to end of line", "difficulty": "intermediate"},
            {"level": 124, "command": "v$", "description": "Visual to end of line", "difficulty": "intermediate"},
            {"level": 125, "command": "d0", "description": "Delete to start of line", "difficulty": "intermediate"},
            {"level": 126, "command": "c0", "description": "Change to start of line", "difficulty": "intermediate"},
            {"level": 127, "command": "y0", "description": "Yank to start of line", "difficulty": "intermediate"},
            {"level": 128, "command": "v0", "description": "Visual to start of line", "difficulty": "intermediate"},
            {"level": 129, "command": "gg", "description": "Go to top of file", "difficulty": "intermediate"},
            {"level": 130, "command": "G", "description": "Go to bottom of file", "difficulty": "intermediate"},
            {"level": 131, "command": "u", "description": "Undo", "difficulty": "beginner"},
            {"level": 132, "command": "Ctrl-r", "description": "Redo", "difficulty": "intermediate"},
            {"level": 133, "command": "o", "description": "Open line below", "difficulty": "beginner"},
            {"level": 134, "command": "O", "description": "Open line above", "difficulty": "beginner"},
            {"level": 135, "command": "a", "description": "Append after cursor", "difficulty": "beginner"},
            {"level": 136, "command": "A", "description": "Append at end of line", "difficulty": "beginner"},
            {"level": 137, "command": "x", "description": "Delete character", "difficulty": "beginner"},
            {"level": 138, "command": "r", "description": "Replace character", "difficulty": "intermediate"},
            {"level": 139, "command": ":", "description": "Command mode", "difficulty": "beginner"}
        ];

        // Skill tracking
        function startTask() {
            startTime = Date.now();
            console.log("Task started");
        }

        function endTask(success) {
            const timeTaken = (Date.now() - startTime) / 1000;
            const accuracy = success ? 100 : 0;
            console.log(`Task ended: time=${timeTaken}s, success=${success}`);
            updateSkillLevel(timeTaken, accuracy);
        }

        function updateSkillLevel(timeTaken, accuracy) {
            if (accuracy > 95 && timeTaken < 15) {
                skillLevel = 'advanced';
            } else if (accuracy > 80 && timeTaken < 30) {
                skillLevel = 'intermediate';
            } else {
                skillLevel = 'beginner';
            }
            console.log(`Skill level updated to ${skillLevel}`);
        }

        // Vim puzzle
        function initVimPuzzle(levelId) {
            if (!window.CodeMirror) {
                console.error("CodeMirror not loaded");
                return;
            }
            flightMode = false;
            document.getElementById('mode-indicator').textContent = "Insert Mode (press Escape to return to Flight Mode)";
            const container = document.getElementById('editor-container');
            container.style.display = 'block';
            startTask();
            const cmd = commands.find(c => c.level === levelId) || { command: "dd", description: "Delete line" };
            const puzzleText = `Edit this text for level ${levelId}.\nDelete this line with ${cmd.command}.`;
            editor = CodeMirror(container, {
                value: puzzleText,
                mode: 'text',
                keyMap: 'vim',
                lineNumbers: true,
                theme: 'default'
            });
            editor.on('change', () => {
                if (editor.getValue() === `Edit this text for level ${levelId}.`) {
                    document.getElementById('editor-container').style.display = 'none';
                    levelCompleteSound.play();
                    endTask(true);
                    updateScore(50);
                    flightMode = true;
                    document.getElementById('mode-indicator').textContent = "Flight Mode";
                    if (currentLevel + 1 < levels.length) {
                        levels[currentLevel + 1].userData.unlocked = true;
                        updateLevelColors();
                    }
                    console.log(`Vim puzzle completed for level ${levelId}`);
                }
            });
        }

        // Bubble shooter (maze or doubling)
        function initBubbleShooter(levelId, isDoubling = false) {
            flightMode = false;
            isBubbleMode = true;
            document.getElementById('mode-indicator').textContent = isDoubling ?
                "Insert Mode: Double the number of boxes (press Escape to return to Flight Mode)" :
                "Insert Mode (press Escape to return to Flight Mode)";
            bubbles.forEach(b => scene.remove(b));
            bubbles = [];
            startTask();
            if (isDoubling) {
                const initialCount = 5;
                for (let i = 0; i < initialCount; i++) {
                    const material = new THREE.MeshBasicMaterial({ color: 0x808080 });
                    const geometry = new THREE.BoxGeometry(1, 1, 1);
                    const box = new THREE.Mesh(geometry, material);
                    box.position.set(
                        levels[levelId].position.x + Math.random() * 10 - 5,
                        levels[levelId].position.y + Math.random() * 10 - 5,
                        levels[levelId].position.z + Math.random() * 10 - 5
                    );
                    box.userData = { isBox: true };
                    scene.add(box);
                    bubbles.push(box);
                }
                levels[levelId].userData.initialBoxCount = initialCount;
                console.log(`Doubling minigame started with ${initialCount} boxes`);
            } else {
                const levelCommands = levels[levelId].userData.commands || [];
                levelCommands.forEach(cmd => {
                    const material = new THREE.MeshBasicMaterial({ color: 0x00FFFF, transparent: true, opacity: 0.5 });
                    const geometry = new THREE.BoxGeometry(1, 1, 1);
                    const box = new THREE.Mesh(geometry, material);
                    const pos = levels[levelId].position.clone();
                    box.position.set(pos.x + Math.random() * 2 - 1, pos.y + Math.random() * 2 - 1, pos.z);
                    box.userData = { command: cmd.command, description: cmd.description, isBox: true };
                    scene.add(box);
                    bubbles.push(box);
                    console.log(`Box added: ${cmd.description} (${cmd.command})`);
                });
            }
        }

        function checkBubblePop(input) {
            let popped = false;
            const isDoubling = levels[currentLevel].userData.initialBoxCount !== undefined;
            if (isDoubling) {
                if (input === 'yy p' || input === 'ab' || input === 'fire' || input === 'flare' || input === 'f' || input === ' ') {
                    const initialCount = levels[currentLevel].userData.initialBoxCount;
                    if (input === 'yy p' || input === 'ab') {
                        const currentCount = bubbles.length;
                        for (let i = 0; i < currentCount; i++) {
                            const material = new THREE.MeshBasicMaterial({ color: 0x808080 });
                            const geometry = new THREE.BoxGeometry(1, 1, 1);
                            const box = new THREE.Mesh(geometry, material);
                            box.position.set(
                                levels[currentLevel].position.x + Math.random() * 10 - 5,
                                levels[currentLevel].position.y + Math.random() * 10 - 5,
                                levels[currentLevel].position.z + Math.random() * 10 - 5
                            );
                            box.userData = { isBox: true };
                            scene.add(box);
                            bubbles.push(box);
                        }
                        popSound.play();
                        endTask(true);
                        updateScore(50);
                        commandBuffer = '';
                        document.getElementById('command-input').textContent = `Command: `;
                        popped = true;
                        if (bubbles.length >= initialCount * 2) {
                            levelComplete();
                        }
                    } else if (input === 'fire' || input === 'flare' || input === 'f' || input === ' ') {
                        const material = new THREE.MeshBasicMaterial({ color: 0x808080 });
                        const geometry = new THREE.BoxGeometry(1, 1, 1);
                        const box = new THREE.Mesh(geometry, material);
                        const direction = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
                        box.position.copy(camera.position);
                        box.userData = { isBox: true, velocity: direction.multiplyScalar(5) };
                        scene.add(box);
                        bubbles.push(box);
                        popSound.play();
                        endTask(true);
                        updateScore(10);
                        commandBuffer = '';
                        document.getElementById('command-input').textContent = `Command: `;
                        popped = true;
                        if (bubbles.length >= initialCount * 2) {
                            levelComplete();
                        }
                    }
                }
            } else {
                bubbles.forEach((bubble, index) => {
                    if (input === bubble.userData.command || input === 'fire' || input === 'flare' || input === 'f' || input === ' ') {
                        scene.remove(bubble);
                        bubbles.splice(index, 1);
                        popSound.play();
                        endTask(true);
                        updateScore(10);
                        commandBuffer = '';
                        document.getElementById('command-input').textContent = `Command: `;
                        popped = true;
                        if (bubbles.length === 0) {
                            levelComplete();
                        }
                    } else if (input === 'dd') {
                        bubbles.forEach(b => scene.remove(b));
                        bubbles = [];
                        popSound.play();
                        endTask(true);
                        updateScore(50);
                        commandBuffer = '';
                        document.getElementById('command-input').textContent = `Command: `;
                        levelComplete();
                        popped = true;
                    }
                });
            }
            if (!popped && input) {
                errorSound.play();
                endTask(false);
            }
        }

        function levelComplete() {
            isBubbleMode = false;
            levelCompleteSound.play();
            endTask(true);
            updateScore(50);
            if (currentLevel + 1 < levels.length) {
                levels[currentLevel + 1].userData.unlocked = true;
                updateLevelColors();
            }
            flightMode = true;
            document.getElementById('mode-indicator').textContent = "Flight Mode";
            console.log(`Level ${currentLevel} completed`);
        }

        function togglePlaylistViewer() {
            if (aboutMode) toggleAboutViewer();
            playlistMode = !playlistMode;
            const container = document.getElementById('playlist-container');
            if (playlistMode) {
                container.style.display = 'block';
                updatePlaylistViewer();
                document.getElementById('mode-indicator').textContent = "Playlist Mode (press Escape to return)";
            } else {
                container.style.display = 'none';
                document.getElementById('mode-indicator').textContent = flightMode ? "Flight Mode" : "Insert Mode (press Escape to return to Flight Mode)";
            }
        }

        function updatePlaylistViewer() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = '<h3>Playlist</h3>';
            if (!Array.isArray(tracks) || tracks.length === 0) {
                container.innerHTML += '<p>(no tracks found — ensure js/playlist.js defines window.playlistFiles or check playlist/ folder)</p>';
                return;
            }
            tracks.forEach((file, index) => {
                const active = index === playlistIndex ? '► ' : '';
                const displayFile = decodeURIComponent(file.replace(/^js\//, '').replace(/^playlist\//, ''));
                container.innerHTML += `<p>${active}${displayFile}</p>`;
            });
        }

        function toggleAboutViewer() {
            if (playlistMode) togglePlaylistViewer();
            aboutMode = !aboutMode;
            const container = document.getElementById('about-container');
            container.style.display = aboutMode ? 'block' : 'none';
            document.getElementById('mode-indicator').textContent =
                aboutMode ? "About Mode (press Escape to return)" :
                (flightMode ? "Flight Mode" : "Insert Mode (press Escape to return to Flight Mode)");
        }

        function getLevelColor(levelId) {
            if (levelId === currentLevel) return 0x00FF00;
            if (levelId > currentLevel) return 0xFF4500;
            return 0x0000FF;
        }

        function updateLevelColors() {
            levels.forEach(level => {
                level.material.color.setHex(getLevelColor(level.userData.id));
            });
        }

        function updateLevelIndicators() {
            triangles.forEach(t => scene.remove(t));
            triangles = [];
            if (halo) {
                scene.remove(halo);
                halo = null;
            }
            document.getElementById('level-message').style.display = 'none';
            if (!flightMode || playlistMode || aboutMode) return;
            let nearestLevel = null;
            let minDistance = Infinity;
            levels.forEach(level => {
                const distance = camera.position.distanceTo(level.position);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestLevel = level;
                }
            });
            if (nearestLevel && minDistance < 5) {
                const pos = nearestLevel.position;
                const triangleMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFF00, side: THREE.DoubleSide });
                const triangleGeometry = new THREE.BufferGeometry();
                const vertices = new Float32Array([
                    0, 0.5, 0,
                    -0.25, -0.25, 0,
                    0.25, -0.25, 0
                ]);
                triangleGeometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
                for (let i = 0; i < 4; i++) {
                    const triangle = new THREE.Mesh(triangleGeometry, triangleMaterial);
                    const angle = (i * Math.PI) / 2;
                    triangle.position.set(
                        pos.x + Math.cos(angle) * 1,
                        pos.y + Math.sin(angle) * 1,
                        pos.z
                    );
                    triangle.lookAt(camera.position);
                    scene.add(triangle);
                    triangles.push(triangle);
                }
            }
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const intersects = raycaster.intersectObjects(levels);
            if (intersects.length > 0 && intersects[0].distance < 5 && intersects[0].object.userData.unlocked) {
                selectedLevel = intersects[0].object;
                const ringGeometry = new THREE.RingGeometry(0.6, 0.7, 32);
                const ringMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFF00, side: THREE.DoubleSide });
                halo = new THREE.Mesh(ringGeometry, ringMaterial);
                halo.position.copy(selectedLevel.position);
                halo.lookAt(camera.position);
                scene.add(halo);
                document.getElementById('level-message').style.display = 'block';
            } else {
                selectedLevel = null;
            }
        }

        function selectLevel() {
            console.log("Attempting level selection");
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const intersects = raycaster.intersectObjects(levels);
            if (intersects.length > 0 && intersects[0].distance < 5) {
                const selected = intersects[0].object;
                console.log(`Selected level ${selected.userData.id} (${selected.userData.difficulty})`);
                if (selected.userData.unlocked) {
                    flightMode = false;
                    currentLevel = selected.userData.id;
                    if (currentLevel % 3 === 0) {
                        addMaze(currentLevel);
                    } else if (currentLevel % 2 === 0) {
                        initBubbleShooter(currentLevel, true);
                    } else {
                        initVimPuzzle(currentLevel);
                    }
                } else {
                    errorSound.play();
                    console.log("Level locked");
                }
            } else {
                console.log("No level intersected or too far");
            }
        }

        function addMaze(levelId) {
            flightMode = false;
            document.getElementById('mode-indicator').textContent = "Insert Mode (press Escape to return to Flight Mode)";
            startTask();
            for (let i = 0; i < 10; i++) {
                const material = new THREE.MeshBasicMaterial({ color: 0x808080 });
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const obstacle = new THREE.Mesh(geometry, material);
                obstacle.position.set(
                    levels[levelId].position.x + Math.random() * 10 - 5,
                    levels[levelId].position.y + Math.random() * 10 - 5,
                    levels[levelId].position.z + Math.random() * 10 - 5
                );
                scene.add(obstacle);
                bubbles.push(obstacle);
                console.log(`Maze obstacle added near level ${levelId}`);
            }
        }

        function updateScore(points) {
            score += points;
            document.getElementById('score').textContent = `Score: ${score}`;
        }

        // Mode buttons
        document.getElementById('flight-button').addEventListener('click', () => {
            flightMode = true;
            isBubbleMode = false;
            playlistMode = false;
            aboutMode = false;
            document.getElementById('mode-indicator').textContent = "Flight Mode";
            document.getElementById('editor-container').style.display = 'none';
            document.getElementById('playlist-container').style.display = 'none';
            document.getElementById('about-container').style.display = 'none';
            bubbles.forEach(b => scene.remove(b));
            bubbles = [];
            console.log("Switched to Flight Mode via button");
        });

        document.getElementById('insert-button').addEventListener('click', () => {
            selectLevel();
        });

        document.getElementById('playlist-button').addEventListener('click', () => {
            togglePlaylistViewer();
        });

        document.getElementById('about-button').addEventListener('click', () => {
            toggleAboutViewer();
        });

        document.addEventListener('keydown', (e) => {
            pressedKeys.add(e.key.toLowerCase());
            if (aboutMode) {
                if (e.key === 'Escape') {
                    toggleAboutViewer();
                }
                return;
            }
            if (playlistMode) {
                if (!tracks.length || !backgroundSound) return;
                if (e.key.toLowerCase() === 'n' || e.key.toLowerCase() === 'b') {
                    playlistIndex = (playlistIndex + 1) % tracks.length;
                    const track = tracks[playlistIndex].startsWith('playlist/') ? tracks[playlistIndex] : `js/${tracks[playlistIndex]}`;
                    backgroundSound.src = track;
                    backgroundSound.play().catch(() => console.log("Audio play blocked"));
                    updatePlaylistViewer();
                } else if (e.key.toLowerCase() === 'f') {
                    flightMode = true;
                    isBubbleMode = false;
                    playlistMode = false;
                    aboutMode = false;
                    document.getElementById('mode-indicator').textContent = "Flight Mode";
                    document.getElementById('editor-container').style.display = 'none';
                    document.getElementById('playlist-container').style.display = 'none';
                    document.getElementById('about-container').style.display = 'none';
                    bubbles.forEach(b => scene.remove(b));
                    bubbles = [];
                    console.log("Switched to Flight Mode");
                } else if (e.key === '/' || e.key === '?') {
                    toggleAboutViewer();
                }
                return;
            }
            if (flightMode && (e.key === ' ' || e.key.toLowerCase() === 'i')) {
                selectLevel();
            } else if (e.key.toLowerCase() === 'p') {
                togglePlaylistViewer();
            } else if (e.key.toLowerCase() === 'f') {
                flightMode = true;
                isBubbleMode = false;
                playlistMode = false;
                aboutMode = false;
                document.getElementById('mode-indicator').textContent = "Flight Mode";
                document.getElementById('editor-container').style.display = 'none';
                document.getElementById('playlist-container').style.display = 'none';
                document.getElementById('about-container').style.display = 'none';
                bubbles.forEach(b => scene.remove(b));
                bubbles = [];
                console.log("Switched to Flight Mode");
            } else if (e.key === '/' || e.key === '?') {
                toggleAboutViewer();
            }
            console.log("Key pressed:", e.key, "Pressed keys:", Array.from(pressedKeys));
        });

        document.addEventListener('keyup', (e) => {
            pressedKeys.delete(e.key.toLowerCase());
            console.log("Key released:", e.key);
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (!flightMode) {
                    flightMode = true;
                    isBubbleMode = false;
                    playlistMode = false;
                    aboutMode = false;
                    document.getElementById('mode-indicator').textContent = "Flight Mode";
                    document.getElementById('editor-container').style.display = 'none';
                    document.getElementById('playlist-container').style.display = 'none';
                    document.getElementById('about-container').style.display = 'none';
                    bubbles.forEach(b => scene.remove(b));
                    bubbles = [];
                    console.log("Exited to Flight Mode");
                }
            } else if (flightMode || playlistMode || aboutMode) {
                return;
            } else if (event.key.length === 1) {
                commandBuffer += event.key;
                document.getElementById('command-input').textContent = `Command: ${commandBuffer}`;
                checkBubblePop(commandBuffer);
            } else if (event.key === 'Enter') {
                commandBuffer = '';
                document.getElementById('command-input').textContent = `Command: `;
            } else if (event.key === 'Backspace') {
                commandBuffer = commandBuffer.slice(0, -1);
                document.getElementById('command-input').textContent = `Command: ${commandBuffer}`;
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (flightMode) {
                const delta = 1 / 60;
                const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
                const right = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);
                const up = new THREE.Vector3(0, 1, 0);
                if (pressedKeys.has('w')) camera.position.add(forward.clone().multiplyScalar(movementSpeed * delta));
                if (pressedKeys.has('s')) camera.position.add(forward.clone().multiplyScalar(-movementSpeed * delta));
                if (pressedKeys.has('a')) camera.position.add(right.clone().multiplyScalar(-movementSpeed * delta));
                if (pressedKeys.has('d')) camera.position.add(right.clone().multiplyScalar(movementSpeed * delta));
                if (pressedKeys.has('r')) camera.position.add(up.clone().multiplyScalar(movementSpeed * delta));
                if (pressedKeys.has('f')) camera.position.add(up.clone().multiplyScalar(-movementSpeed * delta));
                if (pressedKeys.has('q')) camera.rotateOnWorldAxis(up, rotationSpeed);
                if (pressedKeys.has('e')) camera.rotateOnWorldAxis(up, -rotationSpeed);
                if (pressedKeys.has('j')) camera.rotateOnAxis(new THREE.Vector3(0, 0, 1).applyQuaternion(camera.quaternion), rotationSpeed);
                if (pressedKeys.has('l')) camera.rotateOnAxis(new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion), -rotationSpeed);
                if (pressedKeys.has('k')) camera.rotateOnAxis(new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion), rotationSpeed);
                if (pressedKeys.has(';')) camera.rotateOnAxis(new THREE.Vector3(0, 0, 1).applyQuaternion(camera.quaternion), -rotationSpeed);
            }
            for (const b of bubbles) {
                if (b.userData && b.userData.velocity) {
                    b.position.addScaledVector(b.userData.velocity, 1/60);
                }
            }
            const positions = dustParticles.geometry.attributes.position.array;
            for (let i = 2; i < positions.length; i += 3) {
                positions[i] += 1;
                if (positions[i] > 0) {
                    positions[i] = -Math.random() * 200 - 10;
                }
            }
            dustParticles.geometry.attributes.position.needsUpdate = true;
            updateLevelIndicators();
            renderer.render(scene, camera);
        }

        function initScene() {
            console.log("Initializing scene");
            if (typeof THREE === 'undefined') {
                console.error('THREE not loaded. Check js/vendor/three.min.js path.');
                return;
            }
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000033);
            document.body.appendChild(renderer.domElement);
            console.log("Renderer initialized");
            camera.position.set(0, 0, 10);
            try {
                if (THREE.OrbitControls) {
                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                } else if (window.OrbitControls) {
                    controls = new window.OrbitControls(camera, renderer.domElement);
                } else {
                    console.warn("OrbitControls not found. Camera will be static.");
                }
                if (controls) {
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                    console.log("OrbitControls initialized");
                }
            } catch (e) {
                console.error("Failed to initialize OrbitControls:", e);
            }
            const starMaterial = new THREE.PointsMaterial({ color: 0xFFFFFF, size: 0.05 });
            const starVertices = [];
            for (let i = 0; i < 10000; i++) {
                const x = (Math.random() - 0.5) * 2000;
                const y = (Math.random() - 0.5) * 2000;
                const z = (Math.random() - 0.5) * 2000;
                starVertices.push(x, y, z);
            }
            const starGeometry = new THREE.BufferGeometry().setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);
            console.log("Star field added");
            const numLevels = 12;
            levels = [];
            const a = 0.1;
            const b = 0.2;
            const maxTheta = 4 * Math.PI;
            for (let i = 0; i < numLevels; i++) {
                const theta = (i / (numLevels - 1)) * maxTheta;
                const radius = a * Math.exp(b * theta) * 10;
                const x = radius * Math.cos(theta);
                const y = radius * Math.sin(theta);
                const z = 0;
                const color = getLevelColor(i);
                const material = new THREE.MeshBasicMaterial({ color: color });
                const geometry = new THREE.SphereGeometry(0.5, 32, 32);
                const level = new THREE.Mesh(geometry, material);
                level.position.set(x, y, z);
                level.userData = {
                    id: i,
                    difficulty: i < 4 ? 'beginner' : i < 8 ? 'intermediate' : 'advanced',
                    unlocked: i === 0,
                    commands: commands.filter(c => c.level === i)
                };
                scene.add(level);
                levels.push(level);
                console.log(`Level ${i} added at (${x.toFixed(2)}, ${y.toFixed(2)}, ${z})`);
            }
            const dustMaterial = new THREE.PointsMaterial({ color: 0xAAAAAA, size: 0.02, opacity: 0.5, transparent: true });
            const dustVertices = [];
            for (let i = 0; i < 2000; i++) {
                const x = (Math.random() - 0.5) * 200;
                const y = (Math.random() - 0.5) * 200;
                const z = -Math.random() * 200 - 10;
                dustVertices.push(x, y, z);
            }
            const dustGeometry = new THREE.BufferGeometry().setAttribute('position', new THREE.Float32BufferAttribute(dustVertices, 3));
            dustParticles = new THREE.Points(dustGeometry, dustMaterial);
            scene.add(dustParticles);
            console.log("Dust particles added");
            console.log("Camera at (0, 0, 10)");
            animate();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            console.log("Window resized");
        });

        window.addEventListener('load', () => {
            initScene();
        });
    </script>
</body>
</html>
